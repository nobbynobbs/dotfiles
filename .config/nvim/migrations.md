# Миграции и Go

Привет. На прошлой неделе в чат гильдии скидывалась ссылка на документ в конфлюенсе,
в котором была сделана попытка разобраться, есть ли у нас __необходимость__ менять
инструмент с помощью которого мы запускаем миграции.

Те кто ознакомился - молодцы, тем кто оставил комментарии - спасибо, зачитывать вслух
тот папирус я не буду, перейду к выводам.

А выводы получились следующие.

- инструмент миграций ДОЛЖЕН реализовывать какой-либо механизм блокировок и обеспечивать
безопасность одновременного запуска нескольких процессов "мигратора". Несмотря на то что
у нас роллинг апдейт и вроде бы нас это не касается, но стратегий деплоя много, и ситуация
вполне может измениться. cli гуся подобного механизма не предоставляет. У них были ишью
об этом, и они сделали реализацию, но воспользоваться ею получится только если использовать
гуся как библиотеку, а не как cli
- упомянутый выше механизм блокировок зачастую реализуется с использованием advisory локов
(так делает не только migrate, но и например tern, и тот же goose)
- учитывая предыдущий пункт и тот факт, что в транзакционном режиме пуллинга advisory локи
не работают, можно сказать, что проблема связанная с возможностью или невозможностью
запустить инструмент миграций используя транзакционный пуллинг, на самом деле таковой
не является, потому что так делать не нужно. Для миграций отдельный пользователь
с сессионным режимом, для OLTP в приложении отдельный с транзакционным.
- при использовании данной схемы команды сталкивались с тем, что накатив миграцию
с созданием таблицы одним пользователем, они не могут обратиться к ней другим 
пользователем, из-за ошибки permission denied. Мы проверили на сервере-песочнице, что если
все делать аккуратно, то схема рабочая, и чтобы подобного больше не происходило, доработал
док в конфлюенсе, описывающий процесс создания кластера и пользователей. Теперь
в инструкции все очень формально и последовательно, кажется что проблем быть не должно.
- аргументы о неудобстве migrate при ошибках и необходимости перезапускать миграции,
об убогости его служебной таблицы, видим, слышим, некоторые разделяем, но их озвучивает
буквально три человека, наверное это недостаточно чтобы осчастливить все команды
необходимостью переехать на гуся, ставить на это дедлайн, как-то это мониторить.

Итого: необходимости менять migrate на гуся нет, более того, если окажется что migrate
что-то не может, не умеет, задепрекейтился или проект умер, то с большой вероятностью
основным кандидатом на замену будет другая птица, tern, за авторством jack cristiansen,
широко известного в узких кругах под ником jackc (автор pgx), потому что в целом похоже
на гуся, но с блокировками. А пока все остается по прежнему.

